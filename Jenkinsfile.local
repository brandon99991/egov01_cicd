/*
 Jenkinsfile ì„ íƒ
   1) Jenkinsfile
       -> Publish over SSHë¡œ WASì „ì†¡ ë° Tomcat ì¬ê¸°ë™
   2) Jenkinsfile2
       -> Publish over SSHë¡œ WASì „ì†¡ 
       -> ì›ê²© ì  í‚¨ìŠ¤ë¡œ Tomcat ì¬ê¸°ë™
*/

pipeline {
    agent any
    // ì  í‚¨ìŠ¤ ì›ê²© ë…¸ë“œì—ì„œ ì‹¤í–‰í• ë•Œ
    // agent { label 'master-jenkins' }

    tools {
        //gradle 'gradle-7.6.1'
        maven 'Maven3.9.9'
        jdk 'JDK8'
    }

    options {
        buildDiscarder(
            logRotator(
                numToKeepStr: '10',          // ë¹Œë“œ ë¡œê·¸ë¥¼ 10ê°œê¹Œì§€ë§Œ ë³´ê´€
                artifactNumToKeepStr: '5'    // ì‚°ì¶œë¬¼(artifact)ì„ 5ê°œê¹Œì§€ë§Œ ë³´ê´€
            )
        )
    }

    parameters {
    choice(name: 'DEPLOY_ENV', choices: ['dev', 'prod'], description: 'ë°°í¬ í™˜ê²½ ì„ íƒ')
    }


    environment {
        //DOCKERHUB_USERNAME = 'brandon9999'
        GITHUB_URL = 'https://github.com/brandon99991/egov01_cicd.git'
        GITHUB_SOURCE_URL = 'https://github.com/brandon99991/egov01.git'

        CLASS_NUM = '2212'
        SPRING_PROFILE = "${params.DEPLY_ENV}"   // local, dev, prod
        WAR_SEND_NAME = "egov01.war"
    }
    
    stages {
        // Source CheckOut
        stage('Source CheckOut') {
            steps {
                git branch: 'main', url: "${env.GITHUB_SOURCE_URL}"      // Source íŒŒì¼ ì €ì¥ì†Œ
            }
        }

        // Source Build
        stage('Source Build') {
            steps {
                //sh "chmod +x ./gradlew"
                //sh "gradle clean build"
                bat "mvn clean deploy"
            }
        }

        // ì•„í‹°íŒ©íŠ¸ ë³´ê´€ ( jobs/jobName/builds/ë¹Œë“œë²ˆí˜¸/archive/targetì— ë³´ê´€ë¨)
        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'target/*.war', fingerprint: true
            }
        }

        // Set WAR Name
        stage('Set WAR Name') {
            steps {
                script {
                def warFile = bat(
                    script: '''
                    for %%f in (target\\*.war) do (
                        echo %%f
                        goto :eof
                    )
                    ''',
                    returnStdout: true
                ).trim()

                env.WAR_NAME = warFile.tokenize('\\').last()   // Artifact ì´ë¦„ ì¶”ì¶œ
                echo "WAR_NAME = ${env.WAR_NAME}"

                // âœ… ê°™ì€ ê²½ë¡œì— ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë³µì‚¬ë³¸ ë§Œë“¤ê¸°
                bat """
                    copy /Y "target\\${env.WAR_NAME}" "target\\${env.WAR_SEND_NAME}"
                """
                echo "Copied to target\\${env.WAR_SEND_NAME}"
                }
            }
        }




        //Release File CheckOut         
        //stage('Release File CheckOut') {
        //    steps {
        //        checkout scmGit(branches: [[name: '*/main']],
        //           extensions: [[$class: 'SparseCheckoutPaths',
        //            sparseCheckoutPaths: [[path: "/${CLASS_NUM}"]]]],
		//			userRemoteConfigs: [[url: "${GITHUB_URL}"]])
        //    }
        //}





        stage('ğŸš¨ğŸš¨ Confirm Deploy ğŸš¨ğŸš¨') {
            when {
                expression { env.SPRING_PROFILE == 'prod' }
            }
            steps {
                script {
                try {
                    currentBuild.description = "â¸ï¸ PROD ë°°í¬ ìŠ¹ì¸ ëŒ€ê¸°ì¤‘"

                    input message: "ìš´ì˜ ë°°í¬ ìŠ¹ì¸ í•„ìš”. ì§„í–‰í• ê¹Œìš”?",
                        ok: "ğŸš€ ìŠ¹ì¸"

                    // âœ… ìŠ¹ì¸ë¨
                    currentBuild.description = "âœ… PROD ë°°í¬ ìŠ¹ì¸ ì™„ë£Œ"
                }
                catch (err) {
                    // âŒ ê±°ì ˆë¨ (Cancel / Abort)
                    currentBuild.description = "âŒ PROD ë°°í¬ ìŠ¹ì¸ ê±°ì ˆë¨"
                    currentBuild.result = 'ABORTED'
                    error "ìš´ì˜ ë°°í¬ê°€ ìŠ¹ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                }
                }
            }
        }









        // WAR Transer to Tomcat
        //stage('WAR Transer to Tomcat') {
        //    steps {
        //        script {
        //            sshPublisher(publishers: [
        //                sshPublisherDesc(
        //                    configName: 'wsl-ssh',
        //                    transfers: [
        //                        sshTransfer(
        //                            sourceFiles: 'target/*.war',
        //                            remoteDirectory: 'webapps',
        //                            flatten: true,
        //                            execTimeout: 30000
        //                        )
        //                    ],
        //                    verbose: true
        //                )
        //            ])
        //        }
        //    }
        //}

        // Restart to Tomcat
        //stage('Restart to Tomcat') {
        //    agent { label 'wsl-jenkins' }
        //    options { skipDefaultCheckout(true) }
        //    steps {
        //        script {
        //            sh "export JAVA_HOME=/home/user01/jdk/jdk1.8.0_77 && JENKINS_NODE_COOKIE=dontKillMe && sh /home/user01/tomcat.home/apache-tomcat-9.0.65/bin/shutdown.sh"
        //            sh "sleep 3"
        //            sh "export JAVA_HOME=/home/user01/jdk/jdk1.8.0_77 && JENKINS_NODE_COOKIE=dontKillMe && nohup sh /home/user01/tomcat.home/apache-tomcat-9.0.65/bin/startup.sh &"
        //            sh "sleep 3"
        //        }
        //    }
        //}




        // Deploy to Tomcat
        stage('Deploy to Tomcat') {
            steps {
                script {
                    echo "* Artifcat Name: ${env.WAR_NAME}"
                    echo "* Artifcat Send Name: ${env.WAR_SEND_NAME}"

                    sshPublisher(publishers: [
                        sshPublisherDesc(
                            configName: 'wsl-ssh',
                            transfers: [
                                sshTransfer(
                                    //sourceFiles: 'target/*.war',
                                    sourceFiles: "target/${env.WAR_SEND_NAME}",
                                    remoteDirectory: 'webapps',
                                    flatten: true,
                                    execCommand: '''
                                        /bin/bash -lc '
                                            export JAVA_HOME="/home/user01/jdk/jdk1.8.0_77"
                                            export PATH="$JAVA_HOME/bin:$PATH"
                                            "/home/user01/tomcat.home/apache-tomcat-9.0.65/bin/shutdown.sh" || true
                                            sleep 5
                                            "/home/user01/tomcat.home/apache-tomcat-9.0.65/bin/startup.sh"
                                        '
                                    ''',
                                    execTimeout: 30000
                                )
                            ],
                            verbose: true
                        )
                    ])
                }
            }
        }
 
    }

}